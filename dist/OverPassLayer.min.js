L.Control.MinZoomIndicator=L.Control.extend({options:{position:"bottomleft"},_layers:{},initialize:function(t){L.Util.setOptions(this,t),this._layers={}},_addLayer:function(t){var e=15;t.options.minzoom&&(e=t.options.minzoom),this._layers[t._leaflet_id]=e,this._updateBox(null)},_removeLayer:function(t){this._layers[t._leaflet_id]=null,this._updateBox(null)},_getMinZoomLevel:function(){var t,e=-1;for(t in this._layers)null!==this._layers[t]&&this._layers[t]>e&&(e=this._layers[t]);return e},onAdd:function(t){this._map=t,t.zoomIndicator=this;var e=this.className,o=this._container=L.DomUtil.create("div",e);return t.on("moveend",this._updateBox,this),this._updateBox(null),o},onRemove:function(t){L.Control.prototype.onRemove.call(this,t),t.off({moveend:this._updateBox},this),this._map=null},_updateBox:function(t){null!==t&&L.DomEvent.preventDefault(t);var e=this._getMinZoomLevel();this._container.innerHTML=-1==e?this.options.minZoomMessageNoLayer:this.options.minZoomMessage.replace(/CURRENTZOOM/,this._map.getZoom()).replace(/MINZOOMLEVEL/,e),this._container.style.display=this._map.getZoom()>=e?"none":"block"},className:"leaflet-control-minZoomIndicator"}),L.LatLngBounds.prototype.toOverpassBBoxString=function(){var t=this._southWest,e=this._northEast;return[t.lat,t.lng,e.lat,e.lng].join(",")},L.OverPassLayer=L.FeatureGroup.extend({options:{minZoom:15,requestPerTile:!0,endPoint:"http://overpass-api.de/api/",query:"(node({{bbox}})[organic];node({{bbox}})[second_hand];);out qt;",timeout:3e4,retryOnTimeout:!1,noInitialRequest:!1,beforeRequest:function(){},afterRequest:function(){},onSuccess:function(t){for(var e=0;e<t.elements.length;e++){var o,n,i,s=t.elements[e];s.id in this.instance._ids||(this.instance._ids[s.id]=!0,o="node"==s.type?new L.LatLng(s.lat,s.lon):new L.LatLng(s.center.lat,s.center.lon),n=this.instance._poiInfo(s.tags,s.id),i=L.circle(o,50,{color:"green",fillColor:"#3f0",fillOpacity:.5}).bindPopup(n),this.instance.addLayer(i))}},onError:function(){},onTimeout:function(){},minZoomIndicatorOptions:{position:"bottomleft",minZoomMessageNoLayer:"no layer assigned",minZoomMessage:"current Zoom-Level: CURRENTZOOM all data at Level: MINZOOMLEVEL"}},initialize:function(t){L.Util.setOptions(this,t),this._layers={},this._ids={},this._requested={}},_poiInfo:function(t,e){var o,n=document.createElement("a"),i=document.createElement("table"),s=document.createElement("div");n.href="http://www.openstreetmap.org/edit?editor=id&node="+e,n.appendChild(document.createTextNode("Edit this entry in iD"));for(var a in t)o=i.insertRow(0),o.insertCell(0).appendChild(document.createTextNode(a)),o.insertCell(1).appendChild(document.createTextNode(t[a]));return s.appendChild(n),s.appendChild(i),s},long2tile:function(t,e){return Math.floor((t+180)/360*Math.pow(2,e))},lat2tile:function(t,e){return Math.floor((1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e))},tile2long:function(t,e){return t/Math.pow(2,e)*360-180},tile2lat:function(t,e){var o=Math.PI-2*Math.PI*t/Math.pow(2,e);return 180/Math.PI*Math.atan(.5*(Math.exp(o)-Math.exp(-o)))},_view2BBoxes:function(t,e,o,n){for(var i,s,a,r,l=14,h=this.long2tile(t,l),u=this.long2tile(o,l),d=this.lat2tile(n,l),p=this.lat2tile(e,l),m=[],c=h;u>=c;c++)for(var _=d;p>=_;_++)r=Math.round(1e6*this.tile2long(c,l))/1e6,s=Math.round(1e6*this.tile2long(c+1,l))/1e6,i=Math.round(1e6*this.tile2lat(_,l))/1e6,a=Math.round(1e6*this.tile2lat(_+1,l))/1e6,m.push(new L.LatLngBounds(new L.LatLng(a,r),new L.LatLng(i,s)));return m},onMoveEnd:function(){if(this._map.getZoom()>=this.options.minZoom){var t,e,o,n,i,s,a=this,r=0,l=!0,h=function(){0===--r&&a.options.afterRequest.call(a)};n=this.options.requestPerTile?this._view2BBoxes(this._map.getBounds()._southWest.lng,this._map.getBounds()._southWest.lat,this._map.getBounds()._northEast.lng,this._map.getBounds()._northEast.lat):new Array(this._map.getBounds()),r=n.length;for(var u=0;u<n.length;u++)if(o=n[u],t=o._southWest.lng,e=o._northEast.lat,t in this._requested&&e in this._requested[t]&&this._requested[t][e]===!0)r--;else{if(t in this._requested||(this._requested[t]={}),this._requested[t][e]=!0,s=this.options.query.replace(/(\{\{bbox\}\})/g,o.toOverpassBBoxString()),i=this.options.endPoint+"interpreter?data=[out:json];"+s,l){var d=this.options.beforeRequest.call(this);if(d===!1)return void this.options.afterRequest.call(this);l=!1}this.sendRequest(i,h)}}},sendRequest:function(t,e){var o=this,n={instance:this};request=new XMLHttpRequest,request.open("GET",t,!0),request.timeout=this.options.timeout,request.ontimeout=function(){o.options.onTimeout.call(n,this),o.options.retryOnTimeout?o.sendRequest(t,e):e()},request.onload=function(){this.status>=200&&this.status<400?o.options.onSuccess.call(n,JSON.parse(this.response)):o.options.onError.call(n,this),e()},request.send()},onAdd:function(t){this._map=t,t.zoomIndicator?(this._zoomControl=t.zoomIndicator,this._zoomControl._addLayer(this)):(this._zoomControl=new L.Control.MinZoomIndicator(this.options.minZoomIndicatorOptions),t.addControl(this._zoomControl),this._zoomControl._addLayer(this)),this.options.noInitialRequest||this.onMoveEnd(),-1!==this.options.query.indexOf("({{bbox}})")&&t.on("moveend",this.onMoveEnd,this)},onRemove:function(t){L.LayerGroup.prototype.onRemove.call(this,t),this._ids={},this._requested={},this._zoomControl._removeLayer(this),t.off({moveend:this.onMoveEnd},this),this._map=null},getData:function(){return this._data}});